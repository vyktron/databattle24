<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ophelia</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cookie&family=Galada&family=Honk&family=Rowdies:wght@300;400;700&display=swap" rel="stylesheet">
</head>

<body>
    <h1 class="title">Ophel.<span class="title-ia">IA</span></h1>
    <div class="container">
        <div class="content">
            <h2>Requête</h2>
            <div class="selected-option">
                <input type="text" id="selected_value" placeholder="Choisissez votre secteur" readonly>
                <span id="clear_option" class="clear-option"></span>
            </div>

            <table id="nested_table" class="nested-table">
                <tbody>
                    {% for option in dropdown_options %}
                        <tr>
                            <td>
                                {% if option.get('sub_secteurs') %}
                                <img src='static/plus.png' class="button-icon" width="20" height="20">
                                {% endif %}
                            </td>
                            <td class="options">{{ option.name }}</td>
                        </tr>
                        {% if option.get('sub_secteurs') %}
                            {% for sub_secteur in option.sub_secteurs %}
                                <tr class="sub-option hidden" data-parent="{{ option.name }}">
                                    <td></td>
                                    <td id = 'td2'>{{ sub_secteur.name }}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            <br>
            <div>
                <label for="user_input">Entrez votre texte:</label>
                <textarea id="user_input" name="user_input" rows="8" cols="50" oninput="updateCharacterCount()"></textarea>
                <div id="character_count"></div>
            </div>
            <button type="button" onclick="submitForm()">Soumettre</button>
        </div>
        <div class="sidebar">
            <h2>Solutions</h2>
            <div class="result-container">
                <table id="result" class="result hidden">
                    <thead>
                        <tr>
                            <th id="r-code">Code</th>
                            <th id="r-title">Titre</th>
                            <th id="r-filtre"><span id="f-energie" onclick="filterBy(0)">Energie <img src="static/down_fill.svg" class="arrow-icon hidden" width="15" height="15"></span>
                            <span id="f-finance" onclick="filterBy(1)">Finance</span>
                            <span id="f-ges" onclick="filterBy(2)">GES</span>
                            <span id="f-cout" onclick="filterBy(3)">Coût</span>
                            <span id="f-nb-rex" onclick="filterBy(4)">Nb rex</span></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="empty-message">Veuillez soumettre votre requête pour obtenir des solutions correspondantes</div>
        </div>
    </div>

    <script>

        var solutions = [];

        function updateCharacterCount() {
            var textarea = document.getElementById('user_input');
            var characterCount = textarea.value.length;
            var maxCharacterCount = 450;
            var characterCountElement = document.getElementById('character_count');
            characterCountElement.textContent = characterCount + '/' + maxCharacterCount;
            // Change the color of the character count based on the number of characters
            if (characterCount > maxCharacterCount) {
                textarea.style.borderColor = '#c95b5b'; characterCountElement.style.fontWeight = 'bold';
                textarea.style.backgroundColor = '#f0d8d8'; characterCountElement.style.color = '#c95b5b';
            } else {
                textarea.style.borderColor = ''; characterCountElement.style.color = '';
                textarea.style.backgroundColor = ''; characterCountElement.style.fontWeight = '';
            }
        }
        updateCharacterCount(); // Initial update

        document.addEventListener("DOMContentLoaded", function() {
        var dropdownOptions = document.querySelectorAll('.options');
        var selectedValue = document.getElementById('selected_value');
        var nestedTable = document.getElementById('nested_table');
        var toggleButtons = document.querySelectorAll('.button-icon');
        var subOptions = document.querySelectorAll('.sub-option');
        var clearOption = document.getElementById('clear_option');
        var input = document.getElementById('selected_value');

        nestedTable.style.display = 'none';
        document.addEventListener("click", function(event) {
            if (!nestedTable.contains(event.target) && !input.contains(event.target)) {
                nestedTable.style.display = 'none';
            }
        });
        toggleButtons.forEach(function(button) {

            button.addEventListener('click', function() {
                var parentOption = this.parentElement.nextElementSibling.textContent;
                var subOptions = document.querySelectorAll('.sub-option[data-parent="' + parentOption + '"]');
                subOptions.forEach(function(subOption) {
                    subOption.classList.toggle('hidden');
                });

                // Toggle icon to plus from minus and vice versa
                if (this.src.includes('plus')) {
                    this.src = 'static/minus.png';
                } else {
                    this.src = 'static/plus.png';
                }
            });      
        });

        subOptions.forEach(function(subOption) {
            subOption.addEventListener('click', function() {
                var text = this.textContent.trim();
                selectedValue.value = text;
                nestedTable.style.display = 'none';
            });
        });
        
        dropdownOptions.forEach(function(option) {
            option.addEventListener('click', function() {
                var text = this.textContent.trim();
                selectedValue.value = text;
                nestedTable.style.display = 'none';
            });
        });

        clearOption.addEventListener('click', function() {
            selectedValue.value = ""; // Efface la valeur
            selectedValue.placeholder = "Choisissez votre secteur"; // Rétablit le placeholder
        });

        input.addEventListener('click', function() {
            if (nestedTable.style.display === 'none') {
                nestedTable.style.display = 'block';
            } else {
                nestedTable.style.display = 'none';
            }
        });
    });
    function display_solution(solution, resultTable) {
        var row = document.createElement("tr");
        var codeCell = document.createElement("td");
        codeCell.innerHTML = '<a href="https://plateforme.kerdos-energy.com/index.php#/sol/' + solution.code + '" target="_blank" style="color: #4caf50;"><img src="static/k_vert.png">' + solution.code + '</a>';
        var titleCell = document.createElement("td");
        titleCell.textContent = solution.title;
        row.appendChild(codeCell);
        row.appendChild(titleCell);
        
        // Create a single row for the entire list
        var subRow = document.createElement("tr");
        subCodeCell = document.createElement("td");
        var dataCell = document.createElement("td");
        // Create a div element to hold the data
        var dataDiv = document.createElement("div");
        // Display data inlined
        dataDiv.style.display = "inline";
        // Add the data to the div
        for (var i = 0; i < solution.data.length; i++) {
            // info about the data depends on the index
            var info = ""; var unit = ""; var color = "";
            switch (i) {
                case 0:
                    info = "Energie:" ; unit = "€e/€"; color = "#4caf50";
                    break;
                case 1:
                    info = "Finance:" ; unit = "€éco./€inv." ; color = "#d8a601";
                    break;
                case 2:
                    info = "GES:" ; unit = "kgCO2e/€"; color = "#8a2a8d";
                    break;
                case 3:
                    info = "Coût:" ; unit = "€"; color = "#c95b5b";
                    break;
                case 4:
                    info = "Nb rex:" ; unit = "";
                    break;
            }
            var dataSpan = document.createElement("span");
            var info_str = ""
            if (solution.data[i] <= 0 && i != 4) {
                info_str = info + " N/A";
            } else {
                info_str = info + " " + solution.data[i] + " " + unit;
            }
            dataSpan.textContent = info_str;
            if (i != 0) {
                var dataVerticalLine = document.createElement("span");
                dataVerticalLine.textContent = "|";
                dataVerticalLine.style.margin = "0 10px";
                dataDiv.appendChild(dataVerticalLine);
            }
            // Set the font size to 14px and font-family to 'Courier New'
            dataSpan.style.fontSize = "14px"; dataSpan.style.fontFamily = "Courier New"; dataSpan.style.color = color; 
            dataDiv.appendChild(dataSpan);
        }
        dataCell.appendChild(dataDiv);
        subRow.appendChild(subCodeCell);
        subRow.appendChild(dataCell);
        
        row.setAttribute("id", "r-row");
        codeCell.setAttribute("id", "r-code");
        subCodeCell.setAttribute("id", "r-code");
        titleCell.setAttribute("id", "r-title");
        // Set display to none for the sub-row
        subRow.style.display = "none";

        // Add a click event listener to the row
        row.addEventListener("click", function() {
            subRow.style.display = subRow.style.display === "none" ? "table-row" : "none";
        });
        row.style.cursor = "pointer";
        resultTable.querySelector("tbody").appendChild(row);
        resultTable.querySelector("tbody").appendChild(subRow);
    }
    function submitForm() {
        var user_input = document.getElementById("user_input").value;
        var selected_option = document.getElementById("selected_value").value;

        // Test if user_input is empty, if so, put the textarea in red
        if (user_input === "") {
            document.getElementById("user_input").style.borderColor = "#c95b5b";
            document.getElementById("user_input").style.backgroundColor = "#f0d8d8";
            alert("Veuillez entrer un texte");
            return;
        } else {
            document.getElementById("user_input").style.borderColor = "";
            document.getElementById("user_input").style.backgroundColor = "";
        }

        // Test if the number of characters in user_input is greater than 1500
        if (user_input.length > 450) {
            document.getElementById("user_input").style.borderColor = "#c95b5b";
            document.getElementById("user_input").style.backgroundColor = "#f0d8d8";
            alert("Le texte ne doit pas dépasser 450 caractères");
            return;
        }

        fetch('/submit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ "user_input": user_input, "selected_option": selected_option })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("empty-message").style.display = "none";
            // Generate tbody rows in the "result" table
            var resultTable = document.getElementById("result");
            // Clear the table body
            resultTable.querySelector("tbody").innerHTML = "";

            solutions = data.solutions
            // Create a new row for each solution
            solutions.forEach(function(solution) {
                display_solution(solution, resultTable);
            });

            // Show the "result" table
            resultTable.classList.remove("hidden");
        })
        .catch(error => console.error('Erreur :', error));
    }
    </script>
</body>
</html>
