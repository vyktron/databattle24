<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ophelia</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cookie&family=Galada&family=Honk&family=Rowdies:wght@300;400;700&display=swap" rel="stylesheet">
</head>

<body>
    <h1 class="title">Ophel.<span class="title-ia">IA</span></h1>
    <div class="container">
        <div class="content">
            <h2>Requête</h2>
            <div class="selected-option">
                <input type="text" id="selected_value" placeholder="Choisissez votre secteur" readonly>
                <span id="clear_option" class="clear-option"></span>
            </div>

            <table id="nested_table" class="nested-table">
                <tbody>
                    {% for option in dropdown_options %}
                        <tr>
                            <td>
                                {% if option.get('sub_secteurs') %}
                                <img src='static/plus.png' class="button-icon" width="20" height="20">
                                {% endif %}
                            </td>
                            <td class="options">{{ option.name }}</td>
                        </tr>
                        {% if option.get('sub_secteurs') %}
                            {% for sub_secteur in option.sub_secteurs %}
                                <tr class="sub-option hidden" data-parent="{{ option.name }}">
                                    <td></td>
                                    <td id = 'td2'>{{ sub_secteur.name }}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            <br>
            <div>
                <label for="user_input">Entrez votre texte:</label>
                <textarea id="user_input" name="user_input" rows="8" cols="50" oninput="updateCharacterCount()"></textarea>
                <div id="character_count"></div>
            </div>
            <button type="button" onclick="submitForm()">Soumettre</button>
        </div>
        <div class="sidebar">
            <h2>Solutions</h2>
            <div class="result-container">
                <table id="result" class="result hidden">
                    <thead>
                        <tr>
                            <th id="r-code">Code</th>
                            <th id="r-title">Titre</th>
                            <th id="r-filtre"><span id="f-energie" onclick="filterBy(0)">Energie <img src="static/down_fill.svg" class="arrow-icon hidden" width="15" height="15"></span>
                            <span id="f-finance" onclick="filterBy(1)">Finance <img src="static/down_fill.svg" class="arrow-icon hidden" width="15" height="15"></span>
                            <span id="f-ges" onclick="filterBy(2)">GES <img src="static/down_fill.svg" class="arrow-icon hidden" width="15" height="15"></span>
                            <span id="f-cout" onclick="filterBy(3)">Coût <img src="static/down_fill.svg" class="arrow-icon hidden" width="15" height="15"></span>
                            <span id="f-nb-rex" onclick="filterBy(4)">Nb rex <img src="static/down_fill.svg" class="arrow-icon hidden" width="15" height="15"></span></th>
                            <th>RLHF</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="empty-message">Veuillez soumettre votre requête pour obtenir des solutions correspondantes</div>
        </div>
    </div>

    <script>

        var solutions = [];
        var solution_embed_rank = [];
        var currentFilter = -1;
        var inDescendingOrder = true;

        function filterByRank() {

            var breaking_point_cost = 20
            // Use the "ranks" keys in the solutions to sort the solutions by the current filter and order
            if (currentFilter === 3 && inDescendingOrder) {
                // Get the breaking point cost
                solutions.forEach(function(solution) {
                    if (solution.data[3]>=0 && solution.ranks[3] < breaking_point_cost) {
                        breaking_point_cost = solution.ranks[3]
                    }
                });
            }
            // For each solution get the rank value of the current filter
            var sortedSolutions = []
            solutions.forEach(function(solution) {
                // Create a list of zeros with the same length as the number of solutions
                sortedSolutions.push(0)
            });
            solutions.forEach(function(solution) {
                // Add the tuple (solution, rank) to the ranks list
                rank = solution.ranks[currentFilter]
                // Put solution in the correct position in the sortedSolutions list
                if (!inDescendingOrder) {
                    rank = solutions.length - rank - 1
                }
                if (currentFilter === 3 && inDescendingOrder) {
                    if (solution.data[3] < 0) {
                        rank = solutions.length - rank - 1
                    }
                    else {
                        rank = rank - breaking_point_cost
                    }

                }
                sortedSolutions[rank] = solution
            });
            return sortedSolutions
        }

        function updateCharacterCount() {
            var textarea = document.getElementById('user_input');
            var characterCount = textarea.value.length;
            var maxCharacterCount = 450;
            var characterCountElement = document.getElementById('character_count');
            characterCountElement.textContent = characterCount + '/' + maxCharacterCount;
            // Change the color of the character count based on the number of characters
            if (characterCount > maxCharacterCount) {
                textarea.style.borderColor = '#c95b5b'; characterCountElement.style.fontWeight = 'bold';
                textarea.style.backgroundColor = '#f0d8d8'; characterCountElement.style.color = '#c95b5b';
            } else {
                textarea.style.borderColor = ''; characterCountElement.style.color = '';
                textarea.style.backgroundColor = ''; characterCountElement.style.fontWeight = '';
            }
        }
        updateCharacterCount(); // Initial update

        document.addEventListener("DOMContentLoaded", function() {
        var dropdownOptions = document.querySelectorAll('.options');
        var selectedValue = document.getElementById('selected_value');
        var nestedTable = document.getElementById('nested_table');
        var toggleButtons = document.querySelectorAll('.button-icon');
        var subOptions = document.querySelectorAll('.sub-option');
        var clearOption = document.getElementById('clear_option');
        var input = document.getElementById('selected_value');

        nestedTable.style.display = 'none';
        document.addEventListener("click", function(event) {
            if (!nestedTable.contains(event.target) && !input.contains(event.target)) {
                nestedTable.style.display = 'none';
            }
        });
        toggleButtons.forEach(function(button) {

            button.addEventListener('click', function() {
                var parentOption = this.parentElement.nextElementSibling.textContent;
                var subOptions = document.querySelectorAll('.sub-option[data-parent="' + parentOption + '"]');
                subOptions.forEach(function(subOption) {
                    subOption.classList.toggle('hidden');
                });

                // Toggle icon to plus from minus and vice versa
                if (this.src.includes('plus')) {
                    this.src = 'static/minus.png';
                } else {
                    this.src = 'static/plus.png';
                }
            });      
        });

        subOptions.forEach(function(subOption) {
            subOption.addEventListener('click', function() {
                var text = this.textContent.trim();
                selectedValue.value = text;
                nestedTable.style.display = 'none';
            });
        });
        
        dropdownOptions.forEach(function(option) {
            option.addEventListener('click', function() {
                var text = this.textContent.trim();
                selectedValue.value = text;
                nestedTable.style.display = 'none';
            });
        });

        clearOption.addEventListener('click', function() {
            selectedValue.value = ""; // Efface la valeur
            selectedValue.placeholder = "Choisissez votre secteur"; // Rétablit le placeholder
        });

        input.addEventListener('click', function() {
            if (nestedTable.style.display === 'none') {
                nestedTable.style.display = 'block';
            } else {
                nestedTable.style.display = 'none';
            }
        });
    });
    function display_solution(solution, resultTable) {
        var row = document.createElement("tr");
        var codeCell = document.createElement("td");
        codeCell.innerHTML = '<a href="https://plateforme.kerdos-energy.com/index.php#/sol/' + solution.code + '" target="_blank" style="color: #4caf50;"><img src="static/k_vert.png">' + solution.code + '</a>';
        var titleCell = document.createElement("td");
        var rlhfCell = document.createElement("td");
        // Create a div element to hold the RLHF data
        var rlhfDiv = document.createElement("div");
        // Add the thumb up icon to the div and thumb down icon
        var thumbUpIcon = document.createElement("img");
        thumbUpIcon.src = "static/thumb_up_2_fill.svg";
        thumbUpIcon.style.width = "20px"; thumbUpIcon.style.height = "20px";
        thumbUpIcon.setAttribute("class", "thumb-up");
        var thumbDownIcon = document.createElement("img");
        thumbDownIcon.src = "static/thumb_down_2_fill.svg";
        thumbDownIcon.setAttribute("class", "thumb-down");
        // filter it to green when clicking on it
        thumbDownIcon.addEventListener("click", function() {
            if (!thumbDownIcon.classList.contains("active")) {
                thumbDownIcon.classList.add("active");
                thumbDownIcon.style.filter = "brightness(0) saturate(100%) invert(22%) sepia(84%) saturate(2547%) hue-rotate(348deg) brightness(82%) contrast(87%)";
                if (thumbUpIcon.classList.contains("active")) {
                    thumbUpIcon.classList.remove("active");
                    thumbUpIcon.style.filter = "none";
                }
            }
            else {
                thumbDownIcon.classList.remove("active");
                thumbDownIcon.style.filter = "none";
            }
        });
        // filter it to green when clicking on it
        thumbUpIcon.addEventListener("click", function() {
            if (!thumbUpIcon.classList.contains("active")) {
                thumbUpIcon.classList.add("active");
                thumbUpIcon.style.filter = "brightness(0) saturate(100%) invert(51%) sepia(99%) saturate(461%) hue-rotate(74deg) brightness(95%) contrast(88%)";
                if (thumbDownIcon.classList.contains("active")) {
                    thumbDownIcon.classList.remove("active");
                    thumbDownIcon.style.filter = "none";
                }
            }
            else {
                thumbUpIcon.classList.remove("active");
                thumbUpIcon.style.filter = "none";
            }
        });
        thumbDownIcon.style.width = "20px"; thumbDownIcon.style.height = "20px";
        rlhfDiv.appendChild(thumbUpIcon);
        rlhfDiv.appendChild(thumbDownIcon);
        rlhfCell.appendChild(rlhfDiv);
        
        titleCell.textContent = solution.title;
        row.appendChild(codeCell);
        row.appendChild(titleCell);
        row.appendChild(rlhfCell);
        
        // Create a single row for the entire list
        var subRow = document.createElement("tr");
        subCodeCell = document.createElement("td");
        var dataCell = document.createElement("td");
        // Create a div element to hold the data
        var dataDiv = document.createElement("div");
        // Display data inlined
        dataDiv.style.display = "inline";
        // Add the data to the div
        for (var i = 0; i < solution.data.length; i++) {
            // info about the data depends on the index
            var info = ""; var unit = ""; var color = "";
            var title = "";
            switch (i) {
                case 0:
                    info = "Energie:" ; unit = "€e/€"; color = "#4caf50";
                    title = "Equivalent Energie économiséeen € par € investi\nConfiance : " + solution.confidences[0] + "%"
                    break;
                case 1:
                    info = "Finance:" ; unit = "€éco./€inv." ; color = "#d8a601";
                    title = "Gain financier en € par € investi\nConfiance : " + solution.confidences[1] + "%"
                    break;
                case 2:
                    info = "GES:" ; unit = "kgCO2e/€"; color = "#8a2a8d";
                    title = "Réduction des émissions de GES en kgCO2e par € investi\nConfiance : " + solution.confidences[2] + "%"
                    break;
                case 3:
                    info = "Coût:" ; unit = "€"; color = "#c95b5b";
                    title = "Coût total de la solution en €\nConfiance : " + solution.confidences[3] + "%"
                    break;
                case 4:
                    info = "Nb rex:" ; unit = "";
                    title = "Nombre d'études de cas"
                    break;
            }
            var dataSpan = document.createElement("span");
            var info_str = ""
            if (solution.data[i] <= 0 && i != 4) {
                info_str = info + " N/A";
            } else {
                info_str = info + " " + solution.data[i] + " " + unit;
            }
            dataSpan.textContent = info_str;
            // Add a text to the span that shows when hovering over the data
            dataSpan.title = title;
            if (i != 0) {
                var dataVerticalLine = document.createElement("span");
                dataVerticalLine.textContent = "|";
                dataVerticalLine.style.margin = "0 10px";
                dataDiv.appendChild(dataVerticalLine);
            }
            // Set the font size to 14px and font-family to 'Courier New'
            dataSpan.style.fontSize = "14px"; dataSpan.style.fontFamily = "Courier New"; dataSpan.style.color = color; 
            dataDiv.appendChild(dataSpan);
        }
        dataCell.appendChild(dataDiv);
        subRow.appendChild(subCodeCell);
        subRow.appendChild(dataCell);
        
        row.setAttribute("id", "r-row");
        codeCell.setAttribute("id", "r-code");
        subCodeCell.setAttribute("id", "r-code");
        titleCell.setAttribute("id", "r-title");
        // Set display to none for the sub-row
        subRow.style.display = "none";

        // Add a click event listener to the row
        titleCell.addEventListener("click", function() {
            subRow.style.display = subRow.style.display === "none" ? "table-row" : "none";
        });
        titleCell.style.cursor = "pointer";
        resultTable.querySelector("tbody").appendChild(row);
        resultTable.querySelector("tbody").appendChild(subRow);
    }
    function filterBy(index) {
        var filter = document.getElementById("f-" + ["energie", "finance", "ges", "cout", "nb-rex"][index]);
        // Test if the filter is already selected (if it is the current filter and in descending order, then sort in ascending order
        // if it is the current filter and in ascending order, then hide the filter)
        if (currentFilter === index) {
            inDescendingOrder = !inDescendingOrder;
            if (!inDescendingOrder) {
                filter.querySelector("img").classList.remove("hidden");
                filter.style.fontWeight = "bold";
                // Change the arrow icon to "up-fill.svg"
                filter.querySelector("img").src = "static/up_fill.svg";
            } else {
                filter.querySelector("img").src = "static/down_fill.svg";
                // Translating the arrow icon to the top
                filter.querySelector("img").classList.add("hidden");
                // Set the font weight to normal
                filter.style.fontWeight = "normal";
                currentFilter = -1;

                solutions 
            }
        } else {
            // If the filter is not selected, then hide the arrow icon for the current filter
            if (currentFilter !== -1) {
                document.getElementById("f-" + ["energie", "finance", "ges", "cout", "nb-rex"][currentFilter]).querySelector("img").classList.add("hidden");
                document.getElementById("f-" + ["energie", "finance", "ges", "cout", "nb-rex"][currentFilter]).querySelector("img").src = "static/down_fill.svg";
                document.getElementById("f-" + ["energie", "finance", "ges", "cout", "nb-rex"][currentFilter]).style.fontWeight = "normal";
                inDescendingOrder = true;
            }
            // Set the current filter to the selected filter
            currentFilter = index;
            // Show the arrow icon for the selected filter
            filter.style.fontWeight = "bold";
            filter.querySelector("img").classList.remove("hidden");
        }

        if (currentFilter !== -1) {
            // Sort the solutions by the current filter
            solutions = filterByRank();
        }
        else {
            solutions = solution_embed_rank;
        }
        var resultTable = document.getElementById("result");
        // Clear the table body
        resultTable.querySelector("tbody").innerHTML = "";
        solutions.forEach(function(solution) {
            display_solution(solution, resultTable);
        });
    }
    function submitForm() {
        var user_input = document.getElementById("user_input").value;
        var selected_option = document.getElementById("selected_value").value;

        // Test if user_input is empty, if so, put the textarea in red
        if (user_input === "") {
            document.getElementById("user_input").style.borderColor = "#c95b5b";
            document.getElementById("user_input").style.backgroundColor = "#f0d8d8";
            alert("Veuillez entrer un texte");
            return;
        } else {
            document.getElementById("user_input").style.borderColor = "";
            document.getElementById("user_input").style.backgroundColor = "";
        }

        // Test if the number of characters in user_input is greater than 1500
        if (user_input.length > 450) {
            document.getElementById("user_input").style.borderColor = "#c95b5b";
            document.getElementById("user_input").style.backgroundColor = "#f0d8d8";
            alert("Le texte ne doit pas dépasser 450 caractères");
            return;
        }

        fetch('/submit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ "user_input": user_input, "selected_option": selected_option })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("empty-message").style.display = "none";
            // Generate tbody rows in the "result" table
            var resultTable = document.getElementById("result");
            // Clear the table body
            resultTable.querySelector("tbody").innerHTML = "";

            solutions = data.solutions
            solution_embed_rank = data.solutions
            // Create a new row for each solution
            solutions.forEach(function(solution) {
                display_solution(solution, resultTable);
            });

            // Show the "result" table
            resultTable.classList.remove("hidden");
            // Hide arrow icons for all filters
            document.getElementById("f-energie").querySelector("img").classList.add("hidden"); document.getElementById("f-energie").style.fontWeight = "normal";
            document.getElementById("f-finance").querySelector("img").classList.add("hidden"); document.getElementById("f-finance").style.fontWeight = "normal";
            document.getElementById("f-ges").querySelector("img").classList.add("hidden"); document.getElementById("f-ges").style.fontWeight = "normal";
            document.getElementById("f-cout").querySelector("img").classList.add("hidden"); document.getElementById("f-cout").style.fontWeight = "normal";
            document.getElementById("f-nb-rex").querySelector("img").classList.add("hidden"); document.getElementById("f-nb-rex").style.fontWeight = "normal";

            currentFilter = -1;
            inDescendingOrder = true;
        })
        .catch(error => console.error('Erreur :', error));
    }
    </script>
</body>
</html>
